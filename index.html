// --- UPDATED saveAsPDF() function ---
async function saveAsPDF() {
    const popup = document.getElementById('pdf-popup');
    const blurOverlay = document.querySelector('.blur-overlay');
    blurOverlay.style.display = 'block';
    popup.style.display = 'block';

    const fileName = getFileName() + '.pdf';
    const pdf = new jsPDF({ orientation: 'landscape', unit: 'px', format: [1920, 1080] });

    const tempContainer = document.createElement('div');
    tempContainer.style.position = 'absolute';
    tempContainer.style.left = '-9999px';
    tempContainer.style.top = '0px';
    tempContainer.style.width = '1920px';
    tempContainer.style.height = '1080px';
    document.body.appendChild(tempContainer);

    const originalSlideIndex = currentSlideIndex;
    const onScreenWidth = document.getElementById('currentSlide').offsetWidth;
    // Set a high resolution for a sharper image.
    const renderScale = 2; 

    for (let i = 0; i < slides.length; i++) {
        showSlide(i + 1);

        const slideContent = document.getElementById('currentSlide').cloneNode(true);
        slideContent.style.width = '1920px';
        slideContent.style.height = '1080px';
        slideContent.style.transform = 'none';
        slideContent.classList.remove('zoomed');

        // Append to temp container to get accurate coordinates
        tempContainer.innerHTML = '';
        tempContainer.appendChild(slideContent);

        // Wait for all images to load
        const images = tempContainer.querySelectorAll('img');
        const promises = Array.from(images).map(img => {
            if (img.complete) return Promise.resolve();
            return new Promise(resolve => {
                img.onload = img.onerror = resolve;
            });
        });
        await Promise.all(promises);

        // Capture with high scale for better quality
        const canvas = await html2canvas(slideContent, {
            width: 1920,
            height: 1080,
            scale: renderScale,
            logging: false,
            useCORS: true,
            letterRendering: true
        });

        const imgData = canvas.toDataURL('image/jpeg', 0.95);
        if (i > 0) pdf.addPage([1920, 1080], 'landscape');

        pdf.addImage(imgData, 'JPEG', 0, 0, 1920, 1080);
        
        // Add links to the current page after the image
        addLinksToPDF(pdf, slideContent, i, 1920 / (1920 * renderScale), 1080 / (1080 * renderScale));
    }

    showSlide(originalSlideIndex + 1);
    document.body.removeChild(tempContainer);
    pdf.save(fileName);

    setTimeout(() => {
        popup.style.display = 'none';
        blurOverlay.style.display = 'none';
    }, 2000);
}

// --- UPDATED addLinksToPDF() function ---
function addLinksToPDF(pdf, slideContent, pageIndex) {
    pdf.setPage(pageIndex + 1);
    const links = slideContent.querySelectorAll('a');

    links.forEach(link => {
        if (!link.href) return;
        
        const rect = link.getBoundingClientRect();
        const x = rect.left;
        const y = rect.top;
        const width = rect.width;
        const height = rect.height;

        if (width > 0 && height > 0) {
            try {
                pdf.link(x, y, width, height, { url: link.href });
            } catch (e) {
                console.error('Error adding link:', e);
            }
        }
    });
}
