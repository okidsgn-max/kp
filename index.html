<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор КП 2.0</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Библиотеки для экспорта (сохранены, как требовалось) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Стили для скроллбара и превью */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .slide-preview {
            width: 100%;
            aspect-ratio: 16/9;
            position: relative;
            background-size: cover;
            background-position: center;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .slide-preview.active {
            border-color: #3b82f6; /* Blue-500 */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        }
        /* Имитация A4/Слайда для экспорта */
        .export-canvas {
            width: 800px; /* Фиксированная ширина для корректного экспорта */
            height: 450px; /* 16:9 */
            background-color: white;
            position: relative;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }
        /* Стили текста на слайдах */
        .slide-content {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            padding: 40px;
            display: flex;
            flex-direction: column;
        }
        .text-shadow { text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden text-slate-800">

    <div id="app" class="flex h-full">
        
        <!-- ЛЕВАЯ ПАНЕЛЬ: НАСТРОЙКИ -->
        <aside class="w-1/3 min-w-[350px] bg-white border-r border-gray-200 flex flex-col h-full shadow-lg z-10">
            <div class="p-4 border-b border-gray-200 bg-slate-50">
                <h1 class="text-xl font-bold text-slate-700"><i class="fa-solid fa-sliders mr-2"></i>Настройки КП</h1>
                <p class="text-xs text-slate-400 mt-1">Выберите слайд справа для редактирования</p>
            </div>

            <div class="flex-1 overflow-y-auto p-6" v-if="currentSlide">
                
                <div class="mb-6 pb-4 border-b border-gray-100">
                    <h2 class="text-lg font-semibold text-blue-600 mb-2">
                        Слайд {{ activeSlideIndex + 1 }}: {{ getSlideTypeName(currentSlide.type) }}
                    </h2>
                </div>

                <!-- ОБЩИЕ НАСТРОЙКИ (ТЕКСТ) -->
                <div class="space-y-4">
                    <div v-if="currentSlide.title !== undefined">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Заголовок</label>
                        <input type="text" v-model="currentSlide.title" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    
                    <div v-if="currentSlide.subtitle !== undefined">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Подзаголовок</label>
                        <textarea v-model="currentSlide.subtitle" rows="2" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                    </div>

                    <!-- 1. & 4. ВЫБОР БАННЕРА (НИШЕВЫЕ) -->
                    <!-- Показываем для Общих, Менеджеров и других стандартных типов -->
                    <div v-if="['general', 'manager', 'intro'].includes(currentSlide.type)">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Фоновый баннер
                            <span v-if="currentSlide.type === 'manager'" class="text-xs text-orange-500 block font-normal">
                                (Автоматически подбирается дочерний баннер, если есть)
                            </span>
                        </label>
                        <select 
                            v-model="currentSlide.bgImage" 
                            @change="handleBannerChange(currentSlide)"
                            class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none"
                        >
                            <option value="">Без фона</option>
                            <!-- Фильтруем список: убираем base, play, action, alldevice -->
                            <option v-for="banner in nicheBanners" :key="banner" :value="banner">
                                {{ banner }}
                            </option>
                        </select>
                    </div>

                    <!-- 2. ВЫБОР БАННЕРА (ИНСТРУКЦИЯ) -->
                    <!-- Специальный список только для слайда Инструкция -->
                    <div v-if="currentSlide.type === 'instruction'">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Тип инструкции (Фон)</label>
                        <select v-model="currentSlide.bgImage" class="w-full p-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 outline-none bg-blue-50">
                            <!-- Только разрешенные: base, play, action, alldevice -->
                            <option v-for="banner in instructionBanners" :key="banner" :value="banner">
                                {{ formatBannerName(banner) }}
                            </option>
                        </select>
                    </div>

                    <!-- Дополнительные поля для Менеджера -->
                    <div v-if="currentSlide.type === 'manager'" class="p-4 bg-gray-50 rounded border border-gray-200 mt-4">
                        <h3 class="font-bold text-sm text-gray-600 mb-2">Контакты менеджера</h3>
                        <div class="space-y-3">
                            <input placeholder="Имя" type="text" v-model="currentSlide.managerName" class="w-full p-2 border rounded text-sm">
                            <input placeholder="Телефон" type="text" v-model="currentSlide.managerPhone" class="w-full p-2 border rounded text-sm">
                            <input placeholder="Email" type="text" v-model="currentSlide.managerEmail" class="w-full p-2 border rounded text-sm">
                        </div>
                    </div>
                </div>

            </div>
            <div v-else class="flex-1 flex items-center justify-center text-gray-400">
                Выберите слайд
            </div>

            <!-- КНОПКИ ДЕЙСТВИЙ -->
            <div class="p-4 border-t border-gray-200 bg-gray-50">
                <button @click="generatePDF" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded transition flex items-center justify-center shadow">
                    <i class="fa-solid fa-file-pdf mr-2"></i> Скачать КП (PDF)
                </button>
            </div>
        </aside>

        <!-- ПРАВАЯ ПАНЕЛЬ: АРТБОРД (СПИСОК СЛАЙДОВ) -->
        <main class="w-2/3 bg-gray-200 h-full overflow-y-auto p-8 flex flex-col items-center">
            
            <div class="mb-4 flex justify-between w-[800px] items-center">
                <h2 class="text-xl font-bold text-gray-700">Предпросмотр</h2>
                <span class="text-sm text-gray-500">Нажмите на слайд для редактирования (Пункт 3)</span>
            </div>

            <!-- Рендеринг слайдов -->
            <div id="export-container">
                <div 
                    v-for="(slide, index) in slides" 
                    :key="index"
                    class="export-canvas cursor-pointer group transition transform hover:scale-[1.01]"
                    :class="{'ring-4 ring-blue-500': activeSlideIndex === index}"
                    @click="activeSlideIndex = index"
                    :style="getSlideStyle(slide)"
                >
                    <!-- Внутренний контент слайда -->
                    <div class="slide-content text-white">
                        
                        <!-- Логотип (статичный пример) -->
                        <div class="absolute top-8 right-8 font-bold text-2xl tracking-widest uppercase opacity-80">LOGO</div>

                        <!-- Контент в зависимости от типа -->
                        <div class="mt-auto mb-10" v-if="slide.type !== 'manager'">
                            <h2 class="text-4xl font-bold mb-4 uppercase drop-shadow-lg leading-tight" style="white-space: pre-line;">{{ slide.title }}</h2>
                            <p class="text-xl opacity-90 drop-shadow-md max-w-2xl" style="white-space: pre-line;">{{ slide.subtitle }}</p>
                        </div>

                        <!-- Разметка для менеджера -->
                        <div v-if="slide.type === 'manager'" class="flex h-full items-center">
                            <div class="w-1/2"></div> <!-- Spacer for banner layout -->
                            <div class="w-1/2 pl-8 pt-20">
                                <h2 class="text-3xl font-bold mb-6 text-white drop-shadow-lg">{{ slide.title }}</h2>
                                <div class="bg-white/10 backdrop-blur-md p-6 rounded-lg border border-white/20">
                                    <p class="text-xl font-bold mb-1">{{ slide.managerName }}</p>
                                    <p class="text-sm opacity-80 mb-4">Персональный менеджер</p>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex items-center"><i class="fa-solid fa-phone mr-3 w-4"></i> {{ slide.managerPhone }}</div>
                                        <div class="flex items-center"><i class="fa-solid fa-envelope mr-3 w-4"></i> {{ slide.managerEmail }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Индикатор выделения (UI only) -->
                    <div class="absolute inset-0 bg-blue-500/10 hidden group-hover:block pointer-events-none" v-if="activeSlideIndex !== index"></div>
                </div>
            </div>

            <div class="h-20"></div> <!-- Spacer -->
        </main>
    </div>

    <script>
        const { createApp, ref, computed, watch } = Vue;

        createApp({
            setup() {
                // Данные состояния
                const activeSlideIndex = ref(0);

                // Полный список всех файлов (как если бы они лежали в папке)
                // Примечание: Использую placeholder-изображения для демо, но логика имен сохранена.
                // В вашем проекте просто замените путь в getImgUrl
                const allBanners = [
                    'sbfitnes.webp', 'sbfitnes2.webp', // Пример пары (Родитель - Дочерний)
                    'auto.webp', 'auto2.webp',
                    'beauty.webp', 'beauty2.webp',
                    'base.webp', 'play.webp', 'action.webp', 'alldevice.webp', // Специальные
                    'default.webp'
                ];

                // Структура слайдов
                const slides = ref([
                    { 
                        type: 'intro', 
                        title: 'Коммерческое\nпредложение', 
                        subtitle: 'Индивидуальные решения для вашего бизнеса', 
                        bgImage: 'sbfitnes.webp' 
                    },
                    { 
                        type: 'general', 
                        title: 'О нашей компании', 
                        subtitle: 'Лидеры рынка с 2010 года', 
                        bgImage: 'default.webp' 
                    },
                    { 
                        type: 'instruction', 
                        title: 'Как подключиться', 
                        subtitle: 'Простые шаги для старта', 
                        bgImage: 'base.webp' // Default for instruction
                    },
                    { 
                        type: 'manager', 
                        title: 'Ваш менеджер (РФ)', 
                        managerName: 'Алексей Иванов',
                        managerPhone: '+7 (999) 000-00-00',
                        managerEmail: 'alex@company.com',
                        bgImage: 'sbfitnes2.webp' // Should auto-sync
                    },
                    { 
                        type: 'manager', 
                        title: 'Ваш менеджер (КЗ)', 
                        managerName: 'Серик Ахметов',
                        managerPhone: '+7 (777) 111-11-11',
                        managerEmail: 'serik@company.kz',
                        bgImage: 'sbfitnes2.webp' 
                    }
                ]);

                // --- 1. & 2. Логика списков баннеров ---
                
                // Список "Исключенные" (эти нельзя в Общих, но можно в Инструкции)
                const specialBanners = ['base.webp', 'play.webp', 'action.webp', 'alldevice.webp'];

                // Вычисляемый список для Общих и Менеджеров (Change 1)
                const nicheBanners = computed(() => {
                    return allBanners.filter(b => !specialBanners.includes(b));
                });

                // Вычисляемый список только для Инструкции (Change 2)
                const instructionBanners = computed(() => {
                    return specialBanners;
                });

                const currentSlide = computed(() => slides.value[activeSlideIndex.value]);

                // Helper: Генерация пути к картинке
                // В реальном проекте это просто: return `./img/${filename}`;
                // Здесь я использую заглушки, чтобы вы видели результат
                const getSlideStyle = (slide) => {
                    let url = '';
                    // Эмуляция путей. В вашем коде оставьте просто папку.
                    // Для демо я использую цвета/плейсхолдеры, если файла нет, но логика имен сохранена.
                    
                    // ВАЖНО: Раскомментируйте эту строку в своем проекте:
                    // return { backgroundImage: `url(img/${slide.bgImage})` };

                    // ДЕМО РЕЖИМ (Генерация цвета на основе имени файла для наглядности)
                    const seed = slide.bgImage ? slide.bgImage.length : 0;
                    const hue = (seed * 50) % 360;
                    
                    // Если это 'base', 'play' и т.д. используем специфичные цвета
                    let color = `hsl(${hue}, 60%, 30%)`;
                    if(slide.bgImage === 'base.webp') color = '#2c3e50';
                    if(slide.bgImage === 'play.webp') color = '#e74c3c';
                    if(slide.bgImage === 'action.webp') color = '#f1c40f';
                    if(slide.bgImage === 'alldevice.webp') color = '#8e44ad';

                    return { 
                        backgroundColor: color,
                        backgroundImage: `url('https://placehold.co/800x450/${color.replace('#','')}/FFFFFF?text=${slide.bgImage}')` 
                    };
                };

                const getSlideTypeName = (type) => {
                    const map = {
                        'intro': 'Главная',
                        'general': 'Общий',
                        'instruction': 'Инструкция',
                        'manager': 'Менеджер'
                    };
                    return map[type] || type;
                };

                const formatBannerName = (name) => {
                    return name.replace('.webp', '').toUpperCase();
                };

                // --- 4. Логика Умных Баннеров (Parent -> Child) ---
                
                const handleBannerChange = (changedSlide) => {
                    // Если мы меняем баннер на слайде, который НЕ является инструкцией
                    // Нам нужно проверить, есть ли "дочерняя" версия этого баннера (с цифрой 2)
                    
                    if (changedSlide.type === 'instruction') return;

                    const mainBanner = changedSlide.bgImage;
                    if (!mainBanner) return;

                    // Попытка найти версию "2" (например sbfitnes.webp -> sbfitnes2.webp)
                    const namePart = mainBanner.replace('.webp', '');
                    const childBannerName = namePart + '2.webp';

                    // Проверяем, существует ли такой файл в нашем списке всех баннеров
                    const hasChildBanner = allBanners.includes(childBannerName);

                    if (hasChildBanner) {
                        // Если есть, обновляем ВСЕ слайды типа 'manager'
                        slides.value.forEach(slide => {
                            if (slide.type === 'manager') {
                                slide.bgImage = childBannerName;
                            }
                        });
                        console.log(`Updated managers to use ${childBannerName}`);
                    } else {
                        // Если дочернего нет, можно либо оставить старый, либо ставить родительский.
                        // По логике задачи: "если он есть". Если нет - ничего не делаем или ставим родительский.
                        // Обычно лучше ничего не ломать.
                    }
                };

                // --- Экспорт PDF (как было, не меняем логику, только интеграция) ---
                const generatePDF = async () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('l', 'px', [800, 450]); // Альбомная, под размер слайда
                    
                    const container = document.getElementById('export-container');
                    const slideElements = container.children;

                    for (let i = 0; i < slideElements.length; i++) {
                        if (i > 0) doc.addPage();
                        
                        // Используем html2canvas
                        const canvas = await html2canvas(slideElements[i], {
                            scale: 2, // Улучшаем качество
                            useCORS: true
                        });
                        
                        const imgData = canvas.toDataURL('image/jpeg', 0.9);
                        doc.addImage(imgData, 'JPEG', 0, 0, 800, 450);
                    }

                    doc.save('Commercial_Proposal.pdf');
                };

                return {
                    slides,
                    activeSlideIndex,
                    currentSlide,
                    nicheBanners,
                    instructionBanners,
                    handleBannerChange,
                    getSlideStyle,
                    getSlideTypeName,
                    formatBannerName,
                    generatePDF
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
